Python whois History
====================

This is a commandline Python 3 app to keep track of the [whois](https://en.wikipedia.org/wiki/WHOIS)
state of a set of domain names, and a couple of basic DNS lookups.  It's
intended to be run nightly via cron/chrony/systemd.  Once established and
having been run for awhile, this will provide a limited version of the
many [online services](https://google.com/search?q=whois+history+lookup)
which offer paid historical info.  Obviously the data generated by this
app will only start from the first time a domain is scanned, and will only
include the specific list of domains, however.

Installation
============

This is a [Python 3](https://python.org) app, so make sure you have that
installed.  It's only ever been tested on Linux, but it should probably
work wherever Python can be run.  It requires a MariaDB/MySQL database.
This app is not found on PyPI, so just check it out of github and run
it locally:

    $ python3 -m venv <virtual_env_name>
    $ . <virtual_env_name>/bin/activate
    $ pip install -r requirements.txt
    $ ./whoishistory.py --help

The modules required by the app are:

* appdirs ~= 1.4
* dnspython ~= 2.2
* mysqlclient ~= 2.1
* python-whois ~= 0.7

Overview of Operations
======================

This script is intended to be run periodically (possibly nightly) via
cron/chrony/systemd, using its `-a`/`--all` and `-q`/`--quiet` options.
That will cause all of the active domains in the database to be queried,
and the app will only generate output when something has changed in the
domain.  For example, in a user's personal crontab entry:

    30 2 * * * /home/<user>/virtualenv/whoishistory/bin/python /home/<user>/git/pywhoishistory/whoishistory.py -a -q

Note that this app is *not* really intended as an alerting system --
there are no built-in alerting mechanisms in the app.  Its use is more
just to have a historical record available for manual querying later
down the line.

If you do want to get some notification of changes do a zone's whois data,
it's recommended that you configure your cron daemon to send out an email
when the command generates output.  (This is the default behavior of many
cron daemons, though possibly not systemd timers.)  You can easily test
your cron email delivery by omitting the `-q` option, which will make the
app report on everything it's doing.

This app does *not* warn you about domain expirations or the like.

As mentioned obliquely, above, this app also keeps track of a few simple
DNS lookups on the main domain record, namely the "main" A, AAAA, and MX
records.  This might not be appropriate for domains whose DNS records
change frequently, so those DNS checks can be disabled on a per-domain
basis.

I have vague intentions of creating a readonly web UI to view the data
generated by this app (probably just in some lame PHP), but for now it is
commandline only.

Usage
=====

When running the app for the first time (regardless of options), it will
create a config file which will contain your database connection information:

    $ ./whoishistory.py
    Example config written to /home/<user>/.config/pywhoishistory/app.ini
    Add database parameters there and restart.

The specified file should be edited to put in the proper MariaDB/MySQL
connection information.  It'll look like this by default:

    [database]
    hostname = HOSTNAME
    port = 3306
    dbname = DBNAME
    username = USERNAME
    password = PASSWORD

The next time the app is run, regardless of arguments, the app will
automatically create the necessary schema on the configured database.

To add a domain to be monitored, add it with the `-d`/`--domain` option:

    $ ./whoishistory.py -d github.com
    github.com - Running checks...
    github.com - Adding to the database
    github.com - Initial state being recorded


Once that's run, you can get a list of all domains being monitored with
the `-l`/`--list` option:

    $ ./whoishistory.py -l
    github.com

You can get info on the domain using `-i`/`--info`:

    github.com
    ==========
    First checked: 2022-01-26 22:29:25
    Last checked: 2022-01-26 22:29:25

                  State Since: 2022-01-26 22:29:25
                    Registrar: MarkMonitor, Inc.
                 WHOIS Server: whois.markmonitor.com
                 Referral URL: None
                 Updated Date: 2020-09-08 09:18:27
                Creation Date: 2007-10-09 18:20:50
              Expiration Date: 2022-10-09 07:00:00
                  Nameservers: dns1.p08.nsone.net, dns2.p08.nsone.net, dns3.p08.nsone.net, dns4.p08.nsone.net, ns-1283.awsdns-32.org, ns-1707.awsdns-21.co.uk, ns-421.awsdns-52.com, ns-520.awsdns-01.net
                       Status: clientDeleteProhibited, clientTransferProhibited, clientUpdateProhibited
                       Emails: abusecomplaints@markmonitor.com, whoisrequest@markmonitor.com
                       DNSSEC: unsigned
              Registrant Name: None
      Registrant Organization: GitHub, Inc.
           Registrant Address: None
              Registrant City: None
             Registrant State: CA
           Registrant Zipcode: None
                   IP Address: 140.82.113.4
                 MX Addresses: 1/aspmx.l.google.com, 10/alt3.aspmx.l.google.com, 10/alt4.aspmx.l.google.com, 5/alt1.aspmx.l.google.com, 5/alt2.aspmx.l.google.com

    (No history to show)

If you add the `-w`/`--whois` argument to the `-i`/`--info` command, the
app will also output the "raw" whois data, instead of just the summarized
info.

To check the domain again, and log any changes which occurred since the
last check, run using `-d`/`--domain` again:

    $ ./whoishistory.py -d github.com
    github.com - Running checks...
    github.com - Changes detected:
     - IP Address: 140.82.114.3 -> 140.82.112.3

Since github.com's primary IP address changes often, the DNS check here
isn't being too useful to us, though it's a good demonstration of the console
reporting that's done when differences are found.  Any other changes to
DNS or whois info will be shown similarly to that.

Since in this case we probably don't want to bother tracking DNS for the
domain, you can disable DNS lookups by adding `--no-dns` to the commandline:

    $ ./whoishistory.py -d github.com --no-dns
    github.com - Running checks...
    github.com - Disabling DNS lookups
    github.com - Changes detected:
     - IP Address: 140.82.113.4 -> (lookups disabled)
     - MX Addresses: 1/aspmx.l.google.com, 10/alt3.aspmx.l.google.com, 10/alt4.aspmx.l.google.com, 5/alt1.aspmx.l.google.com, 5/alt2.aspmx.l.google.com -> (lookups disabled)

The application will remember that setting, so you only have to specify
it the one time.  You can also specify that right off the bat when adding
a domain, if you know ahead of time that you don't want to track DNS.
The `--dns` argument can be used to turn DNS lookups back on:

    $ ./whoishistory.py -d github.com --dns

For testing purposes, you might want to avoid making network calls for
the whois lookups.  The `-f`/`--from-file` argument can be used to read
whois data from a local text file instead of querying the network:

    $ ./whoishistory.py -d github.com -f whoisdata.txt

To run checks on *all* domains currently known in the database, use the
`-a`/`--all` option.  Here's an example with another domain added to the
list:

    $ ./whoishistory.py -a
    github.com - Running checks...
    github.com - No changes to report!

    Waiting 30 seconds...

    rockylinux.org - Running checks...
    rockylinux.org - No changes to report!

As you can see, the app defaults to waiting 30 seconds inbetween each
domain lookup, in an attempt to not trip any ratelimiting.  (Obviously
more of a concern if you have a lot of domains instead of just two.)
That's also the retry delay which will be used if a whois lookup fails.
The delay can be changed with the `-s`/`--secs` option (and also used
with `-d`/`--domain`):

    $ ./whoishistory.py -a -s 15
    $ ./whoishistory.py -d github.com -s 15

Relatedly, by default the app will retry a failing whois lookup three
(3) times before giving up.  This number can also be changed, using
the `-r`/`--retries` argument:

    $ ./whoishistory.py -a -s 15 -r 2

By default the main `-d` and `-a` arguments will be somewhat verbose
about what they're doing.  When run via cron/chrony/systemd/whatever,
you'll probably want to only have output if changes are detected.  That
can be done with the `-q`/`--quiet` argument:

    $ ./whoishistory.py -a -q

If you decide you want to stop monitoring a domain, but keep it in
the database for historical purposes (or because you intend to monitor
it again in the future), you can use the `--deactivate` argument:

    $ ./whoishistory.py --deactivate github.com
    Active checks for github.com disabled
    $ ./whoishistory.py -l
    github.com (active checks disabled, dns lookups disabled)
    rockylinux.org

Note that github.com still has DNS lookups disabled, from above.  To
re-enable a domain, use `--activate`:

    $ ./whoishistory.py --activate github.com
    Active checks for github.com enabled

To completely get rid of a domain and purge all its info from the
database, use the `--purge` argument:

    $ ./whoishistory.py --purge github.com
    github.com purged from database
    $ ./whoishistory.py -l
    rockylinux.org

Finally, if you want to completely wipe the database, so that the next run
of the command rebuilds the schema and starts completely from scratch,
you can use the `--wipe-database` option:

    $ ./whoishistory.py --wipe-database
    WARNING: Wiping database

TODO
====

- Would be nice to be more database-agnostic.  I'd originally planned
  to just use SQLite, which would probably be more useful to most folks,
  but I probably want to write a web frontend w/ PHP, and it'll be
  easier to use MariaDB for that.
  - I think MySQLdb/mysqlclient isn't the "best" database connection
    library I could be using, too, though it's the easiest to get installed
    on the CentOS 7 machine I run this on.
  - Relatedly, could really make use of a "real" database abstraction
    layer, maybe even take advantage of real migrations instead of my
    proposed poor-man's version.
- A basic readonly web frontend
- Might be nice to be able to specify an alternate config file location, for
  the database connection params?

Not TODO
========

Some things I'm not really interested in implementing myself, though if
someone else submits a PR, I'd at least consider it

- "Active" notifications (emails or whatever generated by the app itself,
  rather than implicitly by the cron daemon)
- Grouping of domains, to facilitate different groups of people wanting
  to monitor different sets of domains but using the same database.  At
  the moment that'd require a separate database per person/group.
- A fully-featured web frontend.  This has to be configured on the shell
  to get into cron/whatever anyway, and the CLI is almost certainly where
  95% of my interaction would be, so if I do a web frontend at all, it
  won't be extensive.

License
=======

This project is licensed under the
[3-clause BSD license](https://opensource.org/licenses/BSD-3-Clause).
See [COPYING.txt](COPYING.txt) for the full text of the license.

Changelog
=========

**v1.0.0**: *2022-01-27*
 - Initial release

